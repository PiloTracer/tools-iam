# Tutorial: Integrating Applications with Tools IAM

This guide explains how to connect an external **Client Application** (e.g., CodeIva Dashboard) to **Tools IAM (Keycloak)**.

## 1. Important Concepts: Who is the Client?

There are two different "Client IDs" involved in the full flow. **Do not confuse them.**

### A. The External App (Your Dashboard)
- **Role**: Validates users against Keycloak.
- **Client ID**: `tools-dashboard-client` (Created inside Keycloak).
- **Secret**:
    - **Required** for Backend Apps (Confidential).
    - **NOT Required** for Frontend/SPA Apps (Public Client) - *Use PKCE instead*.

### B. The Social Provider (Google)
- **Role**: Allows Keycloak to trust Google.
- **Client ID**: `21308269...apps.googleusercontent.com` (From Google Console).
- **Secret**: `ghp_...`
- **Location**: Configured in **Keycloak Admin Console** > **Identity Providers**. *Never in your external app code.*

---

## 2. Step-by-Step Integration

### Scenario: Remote "tools-dashboard-client" (Frontend)
Your remote application runs at `http://localhost:18081` (Host Port) and authenticates users via `http://localhost:18090` (Tools IAM).

#### Step 1: Register the App in Keycloak
1.  Log in to Keycloak Admin (`http://localhost:18090`).
2.  Select your Realm (e.g., `codeiva-ecosystem`).
3.  Navigate to **Clients** > **Create Client**.
    - **Client ID**: `tools-dashboard-client`
    - **Name**: Tools Dashboard
4.  **Capability Config**:
    - **Client Authentication**: **OFF** (Public Client).
        - *Why?* Frontends cannot hide secrets.
    - **Standard Flow**: **ON**.
    - **Direct Access Grants**: **OFF**.
5.  **Access Settings**:
    - **Valid Redirect URIs**: `http://localhost:18081/api/auth/callback/keycloak`
    - **Web Origins**: `http://localhost:18081` (for CORS).

#### Step 2: Configure Your External App
Your application needs to know where IAM is.

**NextAuth.js Example**:
```javascript
// [...nextauth].ts
providers: [
  KeycloakProvider({
    // MATCHES the Client ID you created in Keycloak (Step 1)
    clientId: "tools-dashboard-client",
    
    // PUBLIC CLIENT: No secret needed if 'Client Authentication' is OFF
    clientSecret: "", 
    
    // URL of Tools IAM (Must be reachable by the User's Browser)
    issuer: "http://localhost:18090/realms/codeiva-ecosystem",
  })
]
```

### Scenario: Backend Service (Confidential)
If you have a backend service communicating directly with Keycloak.

1.  **Capability Config**:
    - **Client Authentication**: **ON**.
2.  **Credentials Tab**:
    - Copy the **Client Secret** generated by Keycloak.
3.  **App Configuration**:
    - Use both `clientId` and `clientSecret`.

---

## 3. Communication Flow
1.  **User Visits App**: `http://localhost:18081`
2.  **App Redirects User**: 
    - To: `http://localhost:18090/realms/.../auth`
3.  **User Logs In**:
    - User sees Keycloak Login Page.
    - User clicks "Sign in with Google" -> Redirects to Google -> Back to Keycloak.
4.  **Keycloak Redirects Back**:
    - To: `http://localhost:18081/api/auth/callback...`
    - Payload: Authorization Code.
5.  **App Exchanges Code for Token**:
    - App calls `http://localhost:18090/.../token`.
    - Returns **Access Token** (JWT).

## 4. Client App Configuration Reference (Summary)

This is the **ONLY** data you need to configure in your remote Client Application (`http://localhost:18081`).

| Setting | Value | Notes |
| :--- | :--- | :--- |
| **Issuer / Authority** | `http://localhost:18090/realms/codeiva-ecosystem` | The URL of Keycloak. |
| **Client ID** | `tools-dashboard-client` | Must match "Clients" in Keycloak. |
| **Client Secret** | *(Leave Empty)* | For Frontend Apps (Public). |
| **Scopes** | `openid profile email` | Standard OIDC scopes. |
| **Callback Path** | `/api/auth/callback/keycloak` | Depends on your Auth Library (e.g., NextAuth). |

**Verification Endpoints (For debugging)**:
- **Discovery**: `http://localhost:18090/realms/codeiva-ecosystem/.well-known/openid-configuration`
- **Certs**: `http://localhost:18090/realms/codeiva-ecosystem/protocol/openid-connect/certs`
